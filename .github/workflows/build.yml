# This workflow builds your Arduino sketch and creates a public release
# with the compiled .bin file.

name: Build and Release Firmware

on:

  push:
    branches:
      - 'main'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    # This permission is required for the action to create a GitHub Release
    permissions:
      contents: write

    steps:
      # 1. Check out your code
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Set up the Arduino CLI (Command Line Interface)
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # 3. Update the board index
      - name: Update Core Index
        run: arduino-cli core update-index

      # 4. Install the board platform (e.g., esp32, arduino:avr)
      # ---!!! IMPORTANT: CHANGE THIS FOR YOUR BOARD !!!---
      # Example for ESP32:
      - name: Install ESP32 Core
        run: arduino-cli core install esp32:esp32
      # Example for Arduino Uno (AVR):
      # - name: Install AVR Core
      #   run: arduino-cli core install arduino:avr

      # 5. Install any libraries you need
      # (Uncomment and modify this section if your sketch has dependencies)
      - name: Install Libraries
        run: |
           arduino-cli lib install "DFRobotDFPlayerMini"
      #     arduino-cli lib install "WiFi"
      #     arduino-cli lib install "ArduinoJson"

      # 6. Compile the sketch
      # ---!!! IMPORTANT: CHANGE THESE VALUES !!!---
      # --fqbn: Your Fully Qualified Board Name.
      # ./MySketch: The path to your sketch (the folder containing your .ino file)
      - name: Compile Sketch
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --output-dir ./build \
            ./esp32-2432S028_video_player.ino
      
      # 7. Create or Update the "latest" Release
      # This step uses the GitHub CLI (gh) which is pre-installed.
      # It tries to create a release. If it fails (because "latest" exists),
      # it deletes and re-creates it, ensuring the "latest" tag
      # always points to the newest commit on 'main'.
      - name: Create or Update "latest" Release
        env:
          # The GITHUB_TOKEN is automatically provided by Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to create the release. This will tag the current commit as "latest"
          # If it fails (because "latest" tag/release already exists), it will exit with an error.
          gh release create latest \
            --title "Latest Build (main)" \
            --notes "Automatic build from the main branch." \
            --latest \
            --prerelease=false \
            --draft=false \
            ./build/*.bin ./build/*.elf ./build/*.map \
          || \
          ( \
            echo "Release 'latest' already exists. Re-creating..." && \
            # Delete the existing release. This also deletes the "latest" tag.
            gh release delete latest -y && \
            # Re-create the release, which will tag the current commit as "latest"
            gh release create latest \
              --title "Latest Build (main)" \
              --notes "Automatic build from the main branch." \
              --latest \
              --prerelease=false \
              --draft=false \
              ./build/*.bin ./build/*.elf ./build/*.map \
          )
